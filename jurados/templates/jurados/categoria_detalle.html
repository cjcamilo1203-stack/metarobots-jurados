{% extends 'jurados/base.html' %} {% block title %}{{
categoria.get_nombre_display }} - MetaRobots{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{% url 'jurados:home' %}">Inicio</a>
        </li>
        <li class="breadcrumb-item active">
          {{ categoria.get_nombre_display }}
        </li>
      </ol>
    </nav>

    <h1 class="mb-4">
      {% if categoria.nombre == 'rally' %}
      <i class="bi bi-car-front text-success"></i>
      {% elif categoria.nombre == 'velocista' %}
      <i class="bi bi-lightning text-danger"></i>
      {% endif %} {{ categoria.get_nombre_display }}
    </h1>
  </div>
</div>

<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <h3>Robots Registrados</h3>
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#robotModal"
      >
        <i class="bi bi-plus-circle"></i> Agregar Robot
      </button>
    </div>
  </div>
</div>

{% if robots %}
<div class="row">
  {% for robot in robots %}
  <div class="col-md-6 col-lg-4 mb-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">
          <i class="bi bi-robot"></i> {{ robot.nombre }}
        </h5>
        <p class="card-text">
          <strong>Autor principal:</strong> {{ robot.autor_principal }}<br />
          {% if robot.autor_secundario %}
          <strong>Autor secundario:</strong> {{ robot.autor_secundario }}<br />
          {% endif %}
          <strong>Mejor tiempo:</strong>
          {% if robot.mejor_tiempo %}
          <span class="badge bg-success">{{ robot.mejor_tiempo }}s</span>
          {% else %}
          <span class="badge bg-secondary">Sin tiempos</span>
          {% endif %}
        </p>
      </div>
      <div class="card-footer">
        <div class="btn-group w-100" role="group">
          <a
            href="{% url 'jurados:robot_detalle' robot.id %}"
            class="btn btn-outline-primary btn-sm"
          >
            <i class="bi bi-eye"></i> Ver
          </a>
          <button
            type="button"
            class="btn btn-outline-warning btn-sm"
            onclick="editarRobot({{ robot.id }}, '{{ robot.nombre }}', '{{ robot.autor_principal }}', '{{ robot.autor_secundario|default:'' }}')"
          >
            <i class="bi bi-pencil"></i> Editar
          </button>
          <button
            type="button"
            class="btn btn-outline-danger btn-sm"
            onclick="eliminarRobot({{ robot.id }}, '{{ robot.nombre }}')"
          >
            <i class="bi bi-trash"></i> Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div class="row mt-4">
  <div class="col-12">
    <h3>Ranking de Tiempos</h3>
    <div class="card robot-ranking">
      <div class="card-body">
        {% if ranking %}
        <div class="table-responsive">
          <table class="table table-dark table-striped">
            <thead>
              <tr>
                <th>Posición</th>
                <th>Robot</th>
                <th>Mejor Tiempo</th>
                <th>Autor(es)</th>
              </tr>
            </thead>
            <tbody>
              {% for robot in ranking %}
              <tr>
                <td>
                  <div
                    class="ranking-position {% if forloop.counter == 1 %}position-1 {% elif forloop.counter == 2 %}position-2 {% elif forloop.counter == 3 %}position-3 {% else %}position-other{% endif %}"
                  >
                    {{ forloop.counter }}
                  </div>
                </td>
                <td>{{ robot.nombre }}</td>
                <td>
                  <strong>{{ robot.mejor_tiempo }}s</strong>
                </td>
                <td>
                  {{ robot.autor_principal }} {% if robot.autor_secundario %} &
                  {{ robot.autor_secundario }}{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-center mb-0">No hay tiempos registrados aún.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% else %}
<div class="row">
  <div class="col-12">
    <div class="alert alert-info text-center">
      <i class="bi bi-info-circle"></i>
      <h4>No hay robots registrados</h4>
      <p>Comienza agregando el primer robot para esta categoría.</p>
    </div>
  </div>
</div>
{% endif %}

<!-- Modal para agregar/editar robot -->
<div class="modal fade" id="robotModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="robotModalTitle">Agregar Robot</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form
        id="robotForm"
        method="post"
        action="{% url 'jurados:agregar_robot' categoria.nombre %}"
      >
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="robotId" name="robot_id" />
          <div class="mb-3">
            <label for="nombre" class="form-label">Nombre del Robot *</label>
            <input
              type="text"
              class="form-control"
              id="nombre"
              name="nombre"
              required
            />
          </div>
          <div class="mb-3">
            <label for="autor_principal" class="form-label"
              >Autor Principal *</label
            >
            <input
              type="text"
              class="form-control"
              id="autor_principal"
              name="autor_principal"
              required
            />
          </div>
          <div class="mb-3">
            <label for="autor_secundario" class="form-label"
              >Autor Secundario (Opcional)</label
            >
            <input
              type="text"
              class="form-control"
              id="autor_secundario"
              name="autor_secundario"
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Guardar Robot</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para confirmar eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Eliminación</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          ¿Estás seguro de que deseas eliminar el robot
          <strong id="robotNameToDelete"></strong>?
        </p>
        <p class="text-danger">
          <small
            >Esta acción eliminará también todos los tiempos registrados para
            este robot.</small
          >
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <form id="deleteForm" method="post" style="display: inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  function editarRobot(id, nombre, autorPrincipal, autorSecundario) {
    document.getElementById("robotModalTitle").textContent = "Editar Robot";
    document.getElementById("robotId").value = id;
    document.getElementById("nombre").value = nombre;
    document.getElementById("autor_principal").value = autorPrincipal;
    document.getElementById("autor_secundario").value = autorSecundario;
    document.getElementById("robotForm").action =
      '{% url "jurados:editar_robot" categoria.nombre 0 %}'.replace("0", id);
    new bootstrap.Modal(document.getElementById("robotModal")).show();
  }

  function eliminarRobot(id, nombre) {
    document.getElementById("robotNameToDelete").textContent = nombre;
    document.getElementById("deleteForm").action =
      '{% url "jurados:eliminar_robot" categoria.nombre 0 %}'.replace("0", id);
    new bootstrap.Modal(document.getElementById("deleteModal")).show();
  }

  // Reset modal when closed
  document
    .getElementById("robotModal")
    .addEventListener("hidden.bs.modal", function () {
      document.getElementById("robotModalTitle").textContent = "Agregar Robot";
      document.getElementById("robotForm").reset();
      document.getElementById("robotId").value = "";
      document.getElementById("robotForm").action =
        '{% url "jurados:agregar_robot" categoria.nombre %}';
    });
</script>
{% endblock %}
